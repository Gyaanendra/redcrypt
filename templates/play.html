{% extends "base.html" %}
{% block head_title %}
  Level {{ question.level }}
{% endblock head_title %}
{% block head %}
  <style>
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

.animate-fadeIn {
  animation: fadeIn 0.4s ease-out forwards;
  animation-delay: 0.1s;
  opacity: 0;
}

@keyframes modalFadeIn {
  from { opacity: 0; transform: translateY(-20px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes backdropFadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.modal-open {
  overflow: hidden;
}

.modal-backdrop {
  opacity: 0;
  transition: opacity 0.2s ease-out;
}

.modal-backdrop.show {
  opacity: 1;
}

.modal-content {
  opacity: 0;
  transform: translateY(-20px);
  transition: all 0.3s ease-out;
}

.modal-content.show {
  opacity: 1;
  transform: translateY(0);
}

.stylized-quote {
  position: relative;
  padding: 1rem 3rem;
}

.stylized-quote::before,
.stylized-quote::after {
  position: absolute;
  font-size: 4rem;
  line-height: 1;
  opacity: 0.3;
  transition: all 0.3s ease;
  font-family: 'Press Start 2P', cursive;
  color: #08B74F;
}

.stylized-quote::before {
  content: '<';
  left: 0;
  top: -0.5rem;
}

.stylized-quote::after {
  content: '>';
  right: 0;
  bottom: -0.5rem;
}

.stylized-quote:hover::before,
.stylized-quote:hover::after {
  opacity: 0.6;
  color: #fec84b;
}

@keyframes float {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-2px); }
}

.animate-float {
  animation: float 2s ease-in-out infinite;
}

@keyframes rubberBand {
  from { transform: scale3d(1, 1, 1); }
  30% { transform: scale3d(1.25, 0.75, 1); }
  40% { transform: scale3d(0.75, 1.25, 1); }
  50% { transform: scale3d(1.15, 0.85, 1); }
  65% { transform: scale3d(0.95, 1.05, 1); }
  75% { transform: scale3d(1.05, 0.95, 1); }
  to { transform: scale3d(1, 1, 1); }
}

.animate-rubberBand {
  animation: rubberBand 0.8s cubic-bezier(0.215, 0.61, 0.355, 1);
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  15%, 45%, 75% { transform: translateX(-6px); }
  30%, 60%, 90% { transform: translateX(6px); }
}

.animate-shake {
  animation: shake 0.6s cubic-bezier(.36,.07,.19,.97) both;
}

/* Retro question card with SOLID background */
.question-card {
  border: 3px solid #08b74f;
  border-radius: 4px;
  background: #251809;
  box-shadow:
    inset 0 1px 0 rgba(255, 255, 255, 0.1),
    0 4px 0 rgba(8, 183, 79, 0.4),
    0 8px 30px rgba(0, 0, 0, 0.6);
}

/* Retro input styling */
.retro-input {
  border: 3px solid rgba(221, 207, 181, 0.3);
  border-radius: 4px;
  background: rgba(0, 0, 0, 0.4);
  color: #ddcfb5;
  font-family: 'VT323', monospace;
  font-size: 1.25rem;
  padding: 1rem;
  box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.4);
  transition: all 0.2s ease;
}

.retro-input:focus {
  outline: none;
  border-color: #08b74f;
  background: rgba(0, 0, 0, 0.5);
  box-shadow:
    inset 0 2px 4px rgba(0, 0, 0, 0.3),
    0 0 15px rgba(8, 183, 79, 0.3);
}

.retro-input::placeholder {
  color: rgba(221, 207, 181, 0.4);
}

/* Retro submit button */
.retro-submit-btn {
  font-family: 'Press Start 2P', cursive;
  font-size: 0.7rem;
  border: 3px solid #08b74f;
  border-radius: 4px;
  background: transparent;
  color: #08b74f;
  box-shadow:
    inset 0 -2px 0 rgba(0, 0, 0, 0.3),
    inset 0 1px 0 rgba(255, 255, 255, 0.1),
    0 4px 0 rgba(8, 183, 79, 0.3);
  transition: all 0.15s ease;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.retro-submit-btn:hover:not(:disabled) {
  background: #08b74f;
  color: #2d1d0e;
  transform: translateY(-1px);
  box-shadow:
    inset 0 -2px 0 rgba(0, 0, 0, 0.3),
    inset 0 1px 0 rgba(255, 255, 255, 0.3),
    0 5px 0 rgba(8, 183, 79, 0.4);
}

.retro-submit-btn:active:not(:disabled) {
  transform: translateY(2px);
  box-shadow:
    inset 0 -1px 0 rgba(0, 0, 0, 0.2),
    inset 0 2px 3px rgba(0, 0, 0, 0.3),
    0 2px 0 rgba(8, 183, 79, 0.2);
}

.retro-submit-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Level badge */
.level-badge {
  border: 3px solid #08b74f;
  border-radius: 4px;
  background: rgba(8, 183, 79, 0.1);
  box-shadow: 0 0 15px rgba(8, 183, 79, 0.2);
}

/* Points badge */
.points-badge {
  border: 3px solid #fec84b;
  border-radius: 4px;
  background: rgba(254, 200, 75, 0.1);
}

/* Hints button */
.hints-btn {
  border: 3px solid #f07a1a;
  border-radius: 4px;
  background: rgba(240, 122, 26, 0.1);
  color: #f07a1a;
  font-family: 'VT323', monospace;
  font-size: 1.1rem;
  transition: all 0.2s ease;
}

.hints-btn:hover {
  background: rgba(240, 122, 26, 0.2);
  box-shadow: 0 0 15px rgba(240, 122, 26, 0.3);
}

/* Modal styling */
.retro-modal {
  border: 3px solid #08b74f;
  border-radius: 4px;
  background: linear-gradient(180deg, #2d1d0e 0%, #1f1407 100%);
  box-shadow:
    0 4px 0 rgba(8, 183, 79, 0.4),
    0 8px 40px rgba(0, 0, 0, 0.6);
}

/* Question text styling */
.question-text {
  font-family: 'VT323', monospace;
  font-size: 1.35rem;
  line-height: 1.6;
  color: #ddcfb5;
  letter-spacing: 0.5px;
}
/* Retro Feedback Button */

.feedback-wrapper {
  display: flex;
  justify-content: center;
  margin-top: 2rem;
}

.retro-feedback-btn {
  border: 3px solid #fec84b;
  border-radius: 4px;
  background: rgba(254, 200, 75, 0.1);
  color: #fec84b;
  font-family: 'Press Start 2P', cursive;
  font-size: 0.7rem;
  padding: 12px 18px;
  display: flex;
  align-items: center;
  gap: 10px;
  text-transform: uppercase;
  letter-spacing: 1px;
  box-shadow:
    inset 0 -2px 0 rgba(0,0,0,0.3),
    0 4px 0 rgba(254, 200, 75, 0.35),
    0 0 15px rgba(254, 200, 75, 0.25);
  transition: all 0.15s ease;
}

.retro-feedback-btn:hover {
  background: #fec84b;
  color: #2d1d0e;
  transform: translateY(-2px);
}

.retro-star {
  font-size: 1.2rem;
  animation: float 2s ease-in-out infinite;
}

  </style>
{% endblock head %}
{% block content %}
  <div class="justify-center px-4 pb-8">
    <div class="p-5 mx-auto animate-[fadeIn_0.6s_ease-out] max-w-4xl"
         data-aos="fade-up"
         data-aos-duration="800">
      <div class="flex flex-col items-center gap-4">
        <!-- Level Icon -->
        <div class="w-20 h-20 level-badge flex items-center justify-center">
          <span class="ph-fill ph-question text-4xl text-primary crt-glow"></span>
        </div>
        
        <!-- Level Title -->
        <div class="text-center">
          <h1 class="font-pixel text-3xl md:text-4xl text-primary crt-glow glitch-hover" data-text="Level {{ question.level }}">Level {{ question.level }}</h1>
        </div>
        
        <!-- Badges -->
        <div class="flex gap-3">
          <div class="points-badge px-4 py-2 flex items-center gap-2 text-secondary">
            <i class="ph-fill ph-plus-circle text-accent"></i>
            <span class="retro-text">{{ question.points }} Points</span>
          </div>
          {% if additionalhints %}
            <button id="hints_button"
                    class="hints-btn px-4 py-2 flex items-center gap-2"
                    type="button">
              <span class="flex items-center gap-2">
                <i class="ph-fill ph-lightbulb text-accent"></i>
                <span>View Hints</span>
              </span>
            </button>
          {% endif %}
        </div>
      </div>
    </div>
    
    <!-- Question Card -->
    <div class="md:w-2/3 lg:w-1/2 p-5 mx-auto animate-[fadeIn_0.8s_ease-out]">
      <div class="question-card p-6">
        <!-- Question Text -->
        <div class="p-4 pb-0">
          <div class="stylized-quote">
            <div class="max-w-none question-text text-light leading-relaxed">{{ question.question_text | safe }}</div>
          </div>
          
          <!-- Question Image -->
          {% if question.img_url %}
            <div class="mt-6">
              <a href="{{ question.img_url }}"
                 target="_blank"
                 class="block group relative rounded overflow-hidden pixel-border">
                <img src="{{ question.img_url }}"
                     alt="Question Image"
                     class="max-w-full h-auto pixelated"
                     style="max-height: 400px; object-fit: contain"
                     width="auto"
                     height="auto">
                <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                  <span class="text-light/90 flex items-center gap-2 retro-text">
                    <i class="ph-bold ph-magnifying-glass-plus text-xl text-accent"></i>
                    <span>Click to enlarge</span>
                  </span>
                </div>
              </a>
            </div>
          {% endif %}
        </div>
        
        <!-- Answer Form -->
        <div class="p-6 pt-6 border-t-2 border-primary/20 mt-6">
          <div class="pixel-accent mb-4"></div>
          <form id="answer_form" action="{% url 'check_ans' %}" method="post">
            {% csrf_token %}
            <div class="flex flex-col gap-4">
              <input id="answer"
                     name="answer"
                     type="text"
                     class="retro-input w-full"
                     placeholder="Enter your answer..."
                     required>
              <button type="submit"
                      id="submit"
                      class="retro-submit-btn w-full px-6 py-4 group">
                <div class="flex items-center justify-center gap-3">
                  <i class="ph-bold ph-check text-xl transition-transform group-hover:scale-110"></i>
                  <span class="whitespace-nowrap">Submit Answer</span>
                </div>
              </button>
            </div>
          </form>
          <div class="pixel-accent-amber mt-4"></div>

        </div>
      </div>
    </div>
  </div>
  <!-- Hints Modal -->
{% if additionalhints %}
  <div id="hints-modal"
       role="dialog"
       aria-labelledby="modal-title"
       aria-modal="true"
       class="fixed inset-0 z-50 hidden">
    <div class="modal-backdrop fixed inset-0 bg-dark/80 backdrop-blur-md"></div>
    <div class="fixed inset-0 flex items-center justify-center p-4">
      <div class="modal-content relative w-full max-w-md">
        <div class="retro-modal p-6 relative">

          <!-- Close Button -->
          <button type="button"
                  id="close-modal"
                  class="absolute top-4 right-4 text-light/40 hover:text-light transition-colors p-2 rounded focus:outline-none"
                  aria-label="Close modal">
            <i class="ph-bold ph-x text-2xl text-accent"></i>
          </button>

          <!-- Modal Header -->
          <div class="pixel-accent mb-4"></div>
          <div class="flex items-center gap-3 mb-5">
            <span class="flex items-center justify-center w-10 h-10 border-2 border-accent rounded bg-accent/10">
              <i class="ph-fill ph-lightbulb text-xl text-accent"></i>
            </span>
            <h3 id="modal-title"
                class="font-pixel text-lg text-secondary crt-glow-sm">
              Available Hints
            </h3>
          </div>

          <!-- Hints List -->
          <div class="space-y-4 overflow-y-auto max-h-[calc(100vh-12rem)]">
            {% for hint in additionalhints %}
              <div class="border-2 border-primary/30 rounded p-4 bg-dark/50">
                <div class="flex items-start gap-3">
                  <span class="flex-shrink-0 flex items-center justify-center w-6 h-6 border border-primary rounded text-primary text-sm font-pixel">
                    {{ forloop.counter }}
                  </span>
                  <p class="retro-text text-light/80">
                    {{ hint.hint_text | safe }}
                  </p>
                </div>
              </div>
            {% endfor %}
          </div>

          <div class="pixel-accent-amber mt-4"></div>

          <!-- ⭐ Feedback Button (ADDED — centered retro style) -->
          <div class="feedback-wrapper">
            <button type="button" class="retro-feedback-btn">
              <i class="ph-fill ph-star retro-star"></i>

              Feedback
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

    <script>
const modal = document.getElementById('hints-modal');
const modalContent = modal.querySelector('.modal-content');
const modalBackdrop = modal.querySelector('.modal-backdrop');
const openModalBtn = document.getElementById('hints_button');
const closeModalBtn = document.getElementById('close-modal');

function openModal() {
  modal.classList.remove('hidden');
  document.body.classList.add('modal-open');
  requestAnimationFrame(() => {
    modalBackdrop.classList.add('show');
    modalContent.classList.add('show');
  });
  closeModalBtn.focus();
}

function closeModal() {
  modalBackdrop.classList.remove('show');
  modalContent.classList.remove('show');
  setTimeout(() => {
    modal.classList.add('hidden');
    document.body.classList.remove('modal-open');
  }, 200);
  openModalBtn.focus();
}
openModalBtn.addEventListener('click', openModal);
closeModalBtn.addEventListener('click', closeModal);

modalBackdrop.addEventListener('click', closeModal);

modalContent.addEventListener('click', e => e.stopPropagation());

document.addEventListener('keydown', e => {
  if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
    closeModal();
  }
});
    </script>
  {% endif %}
  
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script>
  let incorrectAttempts = 0; 

$("#answer_form").submit(function (e){
    e.preventDefault();
    var button = document.getElementById("submit");
    var buttonContent = button.querySelector('div');
    var icon = buttonContent.querySelector('i');
    var text = buttonContent.querySelector('span');
    
    button.disabled = true;
    icon.className = "ph-bold ph-circle-notch text-xl animate-spin";
    text.textContent = "Checking...";
    
    var serializedData = $(this).serialize();
    $.ajax({
        type:'POST',
        url:"{% url 'check_ans' %}",
        data:serializedData,
        success:function(response){
            if (response.correct===true){
                icon.className = "ph-bold ph-check-circle text-xl animate-float";
                text.textContent = "Correct!";
                
                var ansinput = document.getElementById("answer");
                ansinput.value = "";
                
                setTimeout(function(){
                    location.reload();
                }, 1000);
            }
            else if (response.correct===false){
                incorrectAttempts++;
                if (incorrectAttempts === 5 && document.getElementById('hints_button')) {
                    showToast("Having trouble? Don't forget to check the available hints!", 5000, "INFO");
                    incorrectAttempts = 0;
                }
                
                icon.className = "ph-bold ph-x-circle text-xl";
                text.textContent = "Try Again";
                button.classList.add("!border-red-500", "!text-red-500");
                
                buttonContent.classList.add('animate-shake');
                
                var ansinput = document.getElementById("answer");
                ansinput.value = "";
                
                buttonContent.addEventListener('animationend', () => {
                    buttonContent.classList.remove('animate-shake');
                }, {once: true});
                
                setTimeout(function(){
                    button.disabled = false;
                    button.classList.remove("!border-red-500", "!text-red-500");
                    icon.className = "ph-bold ph-check text-xl";
                    text.textContent = "Submit Answer";
                },1000);
            }
        },
        error : function(response) {
            if (response.responseJSON.banned === true) {
                window.location.reload();
            }
            icon.className = "ph-bold ph-warning text-xl";
            text.textContent = "Error";
            button.classList.add("!border-amber-500", "!text-amber-500");
            
            var ansinput = document.getElementById("answer");
            ansinput.value = "";
            
            setTimeout(function(){
                button.disabled = false;
                button.classList.remove("!border-amber-500", "!text-amber-500");
                icon.className = "ph-bold ph-check text-xl";
                text.textContent = "Submit Answer";
            },2500);
        }
    });
});
  </script>
  <script>
  window.chatwootSettings = {"position":"right","type":"standard","launcherTitle":"Lead Confirmation"};
  (function(d,t) {
    var BASE_URL="https://chat.fossbu.co";
    var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
    g.src=BASE_URL+"/packs/js/sdk.js";
    g.defer = true;
    g.async = true;
    s.parentNode.insertBefore(g,s);
    g.onload=function(){
      window.chatwootSDK.run({
        websiteToken: '27GNBdL4h2TbebVDB5TjpjTy',
        baseUrl: BASE_URL
      })
    }
  })(document,"script");
  </script>
  {% if user.is_authenticated %}
    <script type="text/javascript">
  window.addEventListener("chatwoot:ready", function () {
  window.$chatwoot.setUser("{{ user.username }}", {
    email: "{{ user.email }}",
    {% if user.profile.name %}
    name: "{{ user.profile.name }}",
    {% else %}
    name: "{{ user.username }}",
    {% endif %}
    avatar_url: "{{ user.profile.avatar }}",
    company: "{{ user.profile.current_level }}",
  });
  window.$chatwoot.setCustomAttributes({
    current_level: "{{ user.profile.current_level }}",
  });
  });
    </script>
  {% endif %}
{% endblock content %}
