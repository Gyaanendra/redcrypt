{% extends "base.html" %}
{% load socialaccount %}
{% load profile_tags %}

{% block head_title %}Edit Profile{% endblock head_title %}

{% block head %}
<style>
  /* Retro toggle switch */
  .switch-wrapper {
    position: relative;
    display: inline-block;
    width: 48px;
    height: 24px;
  }

  .switch-wrapper input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .switch {
    position: absolute;
    cursor: pointer;
    inset: 0;
    background-color: rgba(45, 29, 14, 0.8);
    transition: .3s;
    border-radius: 2px;
    border: 2px solid rgba(221, 207, 181, 0.3);
  }

  .switch:before {
    position: absolute;
    content: "";
    height: 16px;
    width: 16px;
    left: 2px;
    bottom: 2px;
    background-color: #ddcfb5;
    transition: .3s;
    border-radius: 2px;
    box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
  }

  input:checked+.switch {
    background-color: #08b74f;
    border-color: #08b74f;
  }

  input:checked+.switch:before {
    transform: translateX(24px);
    box-shadow: 0 0 10px rgba(8, 183, 79, 0.5);
  }
</style>
{% endblock head %}

{% block content %}
<div class="container mx-auto px-4 my-8 retro-dots">
  <div class="max-w-2xl mx-auto" data-aos="fade-up">
    <div class="retro-card p-6 md:p-8">
      <div class="pixel-accent mb-6"></div>

      <!-- Header -->
      <div class="flex flex-col items-center mb-8">
        <div class="pixel-border pixelated w-20 h-20 md:w-24 md:h-24 mb-4">
          <img src="{% avatar user %}" alt="Profile" class="w-full h-full object-cover pixelated">
        </div>
        <h1 class="font-pixel text-xl md:text-2xl text-primary crt-glow">Edit Profile</h1>
      </div>

      <div class="pixel-accent-amber mb-6"></div>

      <!-- Edit Profile Form -->
      <form id="profile_form" class="space-y-6">
        {% csrf_token %}

        <!-- Username (Disabled) -->
        <div>
          <div class="flex justify-between items-center mb-2">
            <label class="font-pixel text-xs text-light crt-glow-sm">Username</label>
            <div class="group relative">
              <i class="ph-fill ph-info text-light/40 cursor-help"></i>
              <span
                class="absolute -top-8 right-0 bg-dark border-2 border-light/20 px-3 py-1 rounded text-xs text-light whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                Cannot be changed
              </span>
            </div>
          </div>
          <input type="text" value="{{ user.username }}" class="w-full opacity-50 cursor-not-allowed" disabled>
        </div>

        <!-- Email (Disabled) -->
        <div>
          <div class="flex justify-between items-center mb-2">
            <label class="font-pixel text-xs text-light crt-glow-sm">Email</label>
            <div class="group relative">
              <i class="ph-fill ph-info text-light/40 cursor-help"></i>
              <span
                class="absolute -top-8 right-0 bg-dark border-2 border-light/20 px-3 py-1 rounded text-xs text-light whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                Cannot be changed
              </span>
            </div>
          </div>
          <input type="email" value="{{ user.email }}" class="w-full opacity-50 cursor-not-allowed" disabled>
        </div>

        <div class="pixel-accent my-4"></div>

        <!-- Display Name -->
        <div>
          <div class="flex justify-between items-center mb-2">
            <label for="name" class="font-pixel text-xs text-light crt-glow-sm">Display Name</label>
            <div class="flex items-center gap-2">
              <label class="retro-text text-light/60 text-xs">Public</label>
              <label class="switch-wrapper">
                <input type="checkbox" name="is_name_public" {% if profile.is_public_name %}checked{% endif %}>
                <span class="switch"></span>
              </label>
            </div>
          </div>
          <input type="text" id="name" name="name" value="{{ profile.name }}" placeholder="Enter your display name"
            class="w-full">
        </div>

        <!-- Organization -->
        <div>
          <div class="flex justify-between items-center mb-2">
            <label for="organization" class="font-pixel text-xs text-light crt-glow-sm">Organization</label>
            <div class="flex items-center gap-2">
              <label class="retro-text text-light/60 text-xs">Public</label>
              <label class="switch-wrapper">
                <input type="checkbox" name="is_organiz" {% if profile.is_public_organization %}checked{% endif %}>
                <span class="switch"></span>
              </label>
            </div>
          </div>
          <input type="text" id="organization" name="organization" value="{{ profile.organization }}"
            placeholder="Enter your college or organization" class="w-full">
        </div>

        <div class="pixel-accent-amber my-6"></div>

        <!-- Action Buttons -->
        <div class="flex flex-col md:flex-row gap-3">
          <a href="{% url 'profile' %}" class="flex-1">
            <button type="button"
              class="retro-btn w-full bg-dark text-light border-light flex items-center justify-center gap-3 px-4 py-3">
              <i class="ph-bold ph-x"></i>
              <span>Cancel</span>
            </button>
          </a>
          <button type="submit"
            class="retro-btn flex-1 bg-primary text-dark border-primary flex items-center justify-center gap-3 px-4 py-3">
            <i class="ph-bold ph-floppy-disk"></i>
            <span>Save</span>
          </button>
        </div>
      </form>

      <div class="pixel-accent mt-6"></div>
    </div>
  </div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script>
  $(document).ready(function () {
    $('#profile_form').submit(function (e) {
      e.preventDefault();
      const form = $(this);
      const submitBtn = form.find('button[type="submit"]');
      const btnIcon = submitBtn.find('i');
      const btnText = submitBtn.find('span');

      submitBtn.prop('disabled', true);
      btnIcon.removeClass('ph-floppy-disk').addClass('ph-arrows-clockwise animate-spin');
      btnText.text('Saving...');

      $.ajax({
        type: 'POST',
        url: '{% url "save_profile" %}',
        data: form.serialize(),
        success: function (data) {
          showToast("Profile updated successfully!", 3000, 'SUCCESS');
          setTimeout(function () {
            window.location.href = "{% url 'profile' %}";
          }, 1500);
        },
        error: function (response) {
          showToast("Failed to update profile", 3000, 'ERROR');
          submitBtn.prop('disabled', false);
          btnIcon.removeClass('ph-arrows-clockwise animate-spin').addClass('ph-floppy-disk');
          btnText.text('Save');
        }
      });
    });
  });
</script>
{% endblock content %}