{% extends "base.html" %}
{% load static %}
{% load form_filters %}

{% block head_title %}Contact Us{% endblock head_title %}

{% block head %}
<style>
@keyframes fadeInUp {
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.form-field {
  opacity: 0;
  transform: translateY(20px);
  animation: fadeInUp 0.5s forwards;
}
</style>
{% endblock head %}

{% block content %}
<div class="justify-center px-4 pb-8 md:pt-4">
  <!-- Header Section -->
  <div class="max-w-4xl mx-auto" data-aos="fade-up" data-aos-duration="800">
    <div class="flex flex-col items-center gap-4 mb-12">
      <div class="w-20 h-20 border-2 border-accent rounded bg-accent/10 flex items-center justify-center">
        <i class="ph-fill ph-chats text-4xl text-accent crt-glow"></i>
      </div>
      <h1 class="font-pixel text-3xl md:text-4xl text-primary crt-glow">Contact Us</h1>
      <p class="retro-text text-xl text-light/60 text-center">
        Get in touch with us by email at 
        <a href="mailto:admin@redcrypt.ml" class="text-accent hover:text-secondary transition-colors">admin@redcrypt.ml</a>
        {% if user.is_authenticated %} or use the form below{% endif %}
      </p>
    </div>

    {% if user.is_authenticated %}
    <!-- Contact Form Section -->
    <div class="retro-card p-8" data-aos="fade-up" data-aos-delay="100" data-aos-duration="800">
      <div class="pixel-accent mb-6"></div>
      <form action="{% url 'contact_form_submit' %}" method="post" id="contact" class="space-y-6">
        {% csrf_token %}
        
        {% for field in form %}
          <div class="form-field" style="animation-delay: {{ forloop.counter }}00ms">
            {% if field.label != 'HCaptcha' %}
              <div class="flex items-center gap-2 mb-2">
                {% if field.name == 'subject' %}
                  <i class="ph-fill ph-chat-text text-accent text-xl"></i>
                {% elif field.name == 'body' %}
                  <i class="ph-fill ph-article text-accent text-xl"></i>
                {% endif %}
                <label for="{{ field.id_for_label }}" class="font-pixel text-xs text-light crt-glow-sm">{{ field.label }}</label>
              </div>
            {% endif %}
            {{ field|addclass:"w-full" }}
            {% if field.errors %}
              <ul class="mt-1 retro-text text-sm text-red-500">
                {% for error in field.errors %}
                  <li class="flex items-center gap-2">
                    <i class="ph-fill ph-warning text-accent"></i>
                    {{ error }}
                  </li>
                {% endfor %}
              </ul>
            {% endif %}
          </div>
        {% endfor %}

        <div class="form-field flex justify-center" style="animation-delay: 500ms">
          <button type="submit" id="submit"
                  class="retro-btn w-full md:w-auto bg-primary text-dark border-primary hover:bg-secondary flex items-center justify-center gap-3">
            <i class="ph-fill ph-paper-plane-right text-accent"></i>
            Send Message
          </button>
        </div>
      </form>
      <div class="pixel-accent-amber mt-8 mb-4"></div>
    </div>
    {% endif %}
  </div>
</div>
{% endblock content %}

{% block scripts %}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script>
$("#contact").submit(function(e) {
    e.preventDefault();
    const submitBtn = document.getElementById("submit");
    submitBtn.disabled = true;
    submitBtn.innerHTML = `
      <i class="ph-fill ph-spinner animate-spin text-accent"></i>
      Sending...
    `;
    
    const serializedData = $(this).serialize();
    
    $.ajax({
        type: 'POST',
        url: '{% url "contact_form_submit" %}',
        data: serializedData,
        success: function(json) {
            showToast("Message Sent Successfully", 1500, "SUCCESS");
            setTimeout(function() {
                window.location.href = "{% url 'index' %}";
            }, 1500);
        },
        error: function(response) {
            const re = response.responseJSON;
            showToast(re.message, 1500, "ERROR");
            setTimeout(function() {
                submitBtn.disabled = false;
                submitBtn.innerHTML = `
                  <i class="ph-fill ph-paper-plane-right text-accent"></i>
                  Send Message
                `;
            }, 2000);
        }
    });
});
</script>
{% endblock scripts %}
